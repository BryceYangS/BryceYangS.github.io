---
layout: post
title: "[Database] DB Lock"
subtitle: "db lock"
categories: study
tags: db
---
> Databaseì˜ Lockì— ëŒ€í•œ ì´í•´  

# DB Lock
```
ğŸ’¡ Lockì€ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ì˜ ìˆœì°¨ì„±ì„ ë³´ì¥í•´ì£¼ëŠ” ê¸°ëŠ¥ì„ ì œê³µ
```
- íŠ¸ëœì­ì…˜ : **ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ë¥¼ ì¡°ì‘í•˜ëŠ” ì‘ì—…ì˜ ë‹¨ìœ„**
    + íŠ¸ëœì­ì…˜ì˜ ACID 4ê°€ì§€ íŠ¹ì§•
        1. Atomicity(ì›ìì„±)
            * íŠ¸ëœì­ì…˜ì˜ ì‘ì—…ì´ ë¶€ë¶„ì ìœ¼ë¡œ ì„±ê³µí•˜ëŠ” ì¼ì´ ì—†ë„ë¡ ë³´ì¥
            * All or Nothing
        2. Consistency(ì¼ê´€ì„±)
            * íŠ¸ëœì­ì…˜ì´ ëë‚  ë•Œ DBì˜ ì—¬ëŸ¬ ì œì•½ì¡°ê±´ì— ë§ëŠ” ìƒíƒœë¥¼ ë³´ì¥
        3. Isolation(ë…ë¦½ì„±)
            * íŠ¸ëœì­ì…˜ì´ ì§„í–‰ë˜ëŠ” ì¤‘ê°„ ìƒíƒœì˜ ë°ì´í„°ë¥¼ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë³¼ ìˆ˜ ì—†ë„ë¡ ë³´ì¥
        4. Durability(ì˜êµ¬ì„±)
            * íŠ¸ëœì­ì…˜ì´ ì„±ê³µí–ˆì„ ê²½ìš° í•´ë‹¹ ê²°ê³¼ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì ìš©ë¨ì„ ë³´ì¥
- Lockì€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ì™„ë²½í•˜ê²Œ ëë‚  ë•Œê¹Œì§€ ë‹¤ë¥¸ ìš”ì²­ì„ ë§‰ì•„ì¤Œ

## Transactionì˜ Isolation Level
> ACID ì›ì¹™ì€ ì™„ë²½íˆ ì§€ì¼œì§€ì§€ ì•ŠëŠ”ë‹¤   

ACID ì›ì¹™ì„ strictí•˜ê²Œ ì§€í‚¤ë ¤ë©´ **ë™ì‹œì„±ì´ ë§¤ìš° ë–¨ì–´ì§€ê²Œ** ëœë‹¤.  
DB ì—”ì§„ì€ ACID ì›ì¹™ì„ í¬ìƒí•´ ë™ì‹œì„±ì„ ì–»ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•œë‹¤. ë°”ë¡œ ***Transactionì˜ Isolation Level***ì´ë‹¤.  
Isolation ì›ì¹™ì„ ëœ ì§€í‚¤ëŠ” levelì„ ì‚¬ìš©í• ìˆ˜ë¡ ë¬¸ì œê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì€ ì»¤ì§€ì§€ë§Œ **ë” ë†’ì€ ë™ì‹œì„±**ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.  

- Isolation Level : ìƒìœ„ë ˆë²¨(0 ~ 3)ë¡œ ê°ˆìˆ˜ë¡ ê²©ë¦¬ ìˆ˜ì¤€ì´ ë†’ìŒ
    0. `READ UNCOMMITED`
        - **ì»¤ë°‹ë˜ì§€ ì•Šì€ ë‚´ìš©**ê¹Œì§€ ë‹¤ ì½ì„ìˆ˜ ìˆë„ë¡ í•˜ëŠ” **ëŠìŠ¨í•œ ê²©ë¦¬** ìˆ˜ì¤€
        - ë°°íƒ€ì  ì ê¸ˆì´ ê±¸ë ¤ìˆì–´ë„ ì½ì„ ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤
        - `Dirty Read`ì˜ ë¬¸ì œê°€ ë°œìƒ : ë³€ê²½ ì¤‘ì¸ ê°’ì„ ì½ì–´ì˜¤ë©´ ê·¸ ê°’ì´ commit ë˜ëŠ” ìˆœê°„ í‹€ë¦° ê°’ì´ ë˜ê¸° ë•Œë¬¸
    1. `READ COMMITED`
        - **ì»¤ë°‹ëœ ë‚´ìš©ë§Œ ì½ì„ìˆ˜** ìˆë„ë¡ í•˜ëŠ” ê°€ì¥ ë§ì´ ì“°ì´ëŠ” ê²©ë¦¬ ìˆ˜ì¤€
        - ê³µìœ ì ê¸ˆëœ ë‚´ìš©ì€ ì½ì„ ìˆ˜ â­•ï¸, ë°°íƒ€ì  ì ê¸ˆì´ ê±¸ë ¤ìˆìœ¼ë©´ ì½ì„ ìˆ˜ âŒ
        - `NON_REPEATABLE_READ` ë¬¸ì œê°€ ë°œìƒ : ë°°íƒ€ì  ì ê¸ˆì´ ê±¸ë¦¬ê¸° ì „ì— ì½ì€ ê°’ì´ ì§í›„ì— ë³€ê²½ëœë‹¤ë©´ ë‹¤ì‹œ ì¡°íšŒí–ˆì„ ë•Œ ì²˜ìŒê³¼ ë‹¤ë¥¸ ê°’ì´ ë‚˜ì˜¤ê¸° ë•Œë¬¸
    2. `REPEATABLE READ`
        - í•œ íŠ¸ëœì­ì…˜ ë™ì•ˆì—” í•´ë‹¹ë˜ëŠ” **rowì— ëŒ€í•˜ì—¬ DMLì´ ì¼ì–´ë‚  ìˆ˜ ì—†ìŒ**
        - ê³µìœ ì ê¸ˆì´ ê±¸ë¦¬ë©´ í•´ë‹¹ ê²©ë¦¬ìˆ˜ì¤€ì´ ëœë‹¤
        - ì½ì–´ì˜¨ rowì— ëŒ€í•œ Update, DeleteëŠ” ë¶ˆê°€í•¨. ê·¸ë ‡ë‹¤ê³  í…Œì´ë¸”ì— ëŒ€í•œ **Insertê°€ ë¶ˆê°€ëŠ¥í•œ ê²ƒì€ ì•„ë‹˜**
        - `PHANTOM READ` ë¬¸ì œ ë°œìƒ : í•œ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì¼ì • ë²”ìœ„ì˜ ë ˆì½”ë“œë¥¼ ë‘ ë²ˆ ì´ìƒ ì½ì„ ë•Œ, ì²«ë²ˆì§¸ ì¿¼ë¦¬ì—ì„œ ì—†ë˜ ë ˆì½”ë“œê°€ ë‘ë²ˆì§¸ ì¿¼ë¦¬ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” í˜„ìƒ. íŠ¸ëœì­ì…˜1ì´ ì²˜ìŒ ì¡°íšŒì‹œ 0ê±´ì¸ë° ë‹¤ë¥¸ íŠ¸ëœì­ì…˜2ê°€ insertë¥¼ í•˜ê³  commit í•˜ë©´ íŠ¸ëœì­ì…˜1ì´ ë‹¤ì‹œ ì¡°íšŒí–ˆì„ ê²½ìš° 1ê±´ì´ ì¡°íšŒëœë‹¤.
        - `MySql`ì˜ InnoDB ì—”ì§„ì˜ ê¸°ë³¸ Isolation level : ê¸°ì¡´ DBë³´ë‹¤ isolation levelì´ ë†’ë‹¤!!
    3. `SERIALIZABLE`
        - í•œ ì„¸ì…˜ì´ ì¡ê³  ìˆëŠ” ë™ì•ˆ **ë‹¤ë¥¸ ì„¸ì…˜ì˜ íŠ¸ëœì­ì…˜ì´ ëª¨ë‘ ì ‘ê·¼í•  ìˆ˜ ì—†ë„ë¡** í•˜ëŠ” ê²©ë¦¬ ìˆ˜ì¤€
        - ë™ì‹œì„±ì´ ë§¤ìš° ë–¨ì–´ì§
        - ê¸°ë³¸ì ìœ¼ë¡œ REPEATABLE READì™€ ë™ì¼. ëŒ€ì‹ , SELECT ì¿¼ë¦¬ê°€ ì „ë¶€ `SELECT ... FOR SHARE`ë¡œ ìë™ìœ¼ë¡œ ë³€ê²½ëœë‹¤.
        - ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•  ìˆ˜ëŠ” ìˆì§€ë§Œ **ì‰½ê²Œ ë°ë“œë½ì— ê±¸ë¦´ ìˆ˜ ìˆë‹¤**


|Isolation level|Dirty Read|Non-Repeatable Read|Phantom Read|
|---|---|---|---|
|Read Uncommited|ë°œìƒ|ë°œìƒ|ë°œìƒ|
|Read Commited|X|ë°œìƒ|ë°œìƒ|
|Repeatable Read|X|X|ë°œìƒ|
|Serializable|X|X|X|

### MySQLì˜ Consistent read
- íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ non-locking read(ê¸°ë³¸ SELECT êµ¬ë¬¸)ë¥¼ ì‹¤í–‰í•  ë•Œ, ë™ì‹œì— ì‹¤í–‰ì¤‘ì¸ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ë”ë¼ë„ íŠ¹ì • ì‹œì ì˜ ìŠ¤ëƒ…ìƒ·ì„ ì´ìš©í•´ ê¸°ì¡´ê³¼ ë™ì¼í•œ ê²°ê³¼ë¥¼ ë¦¬í„´í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ê¸°ëŠ¥
- Lockì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë™ì‹œì„±ì´ ë†’ìŒ
- ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹œì 
    + `REPEATABLE READ` ê²½ìš° : *íŠ¸ëœì­ì…˜ ì‹œì‘ í›„ ì²« ë²ˆì§¸ read operationì´ ìˆ˜í–‰ë˜ëŠ” ì‹œì *ì˜ ë°ì´í„°ë¡œ ìŠ¤ëƒ…ìƒ·ì´ ìƒì„±ë¨
        * MySql Inno DB ì—”ì§„ì˜ ê²½ìš° consistent read ì‚¬ìš©ìœ¼ë¡œ **REPEATABLE READì„ì—ë„ ë¶ˆêµ¬í•˜ê³  Phantom readê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ**
    + `READ COMMITED` ê²½ìš° : *ë§¤ read operation*ì´ ë°œìƒí•˜ëŠ” ì‹œì ì˜ ë°ì´í„°ë¡œ ìŠ¤ëƒ…ìƒ·ì´ ë‹¤ì‹œ ìƒì„±
- ë¬¸ì œì 
    1. íŠ¸ëœì­ì…˜ ë‚´ ì—ì„œ SELECT ë¥¼ ì‹¤í–‰í•˜ë©´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ë³€ê²½í–ˆë”ë¼ë„ í•­ìƒ ë™ì¼ ê²°ê³¼ ë¦¬í„´
    2. íŠ¸ëœì­ì…˜1ì—ì„œ SELECT - 0ê±´(Snapshot) -> íŠ¸ëœì­ì…˜2 INSERT -> íŠ¸ëœì­ì…˜1 : UPDATE -> íŠ¸ëœì­ì…˜1 SELECT - 1ê±´(REPEATABLE READ ê¹¨ì§)

<br/>

## Inno DBì˜ Lock
Inno DBëŠ” ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ lockì„ ì‚¬ìš©

1. Row-level Lock
2. Record Lock
3. Gap Lock
4. 


## Lock ì¢…ë¥˜
### 1. Shared Lock(ê³µìœ  ì ê¸ˆ)
- Read Lock, ì½ê¸° ì ê¸ˆ
- SELECT ... FOR SHARE
- `ì½ê¸°` í™œë™ì„ í•  ë•Œë§Œ ë°œìƒ
- ê³µìœ ì ê¸ˆë¼ë¦¬ëŠ” ì¶©ëŒí•˜ì§€ ì•ŠìŒ : Read Lockì€ ê°™ì€ Read Lock ë¼ë¦¬ ë™ì‹œ ì ‘ê·¼ ê°€ëŠ¥
- ê³µìœ ì ê¸ˆì´ ê±¸ë¦° ë™ì•ˆ DML (Insert, Update, Delete)ì„ í•  ìˆ˜ ì—†ìŒ
- Transaction Isolationì„ REPEATABLE READë¡œ ë§Œë“¤ì–´ì¤Œ

### 2. Exclusive Lock(ë°°íƒ€ì  ì ê¸ˆ)
- Write Lock, ì“°ê¸° ì ê¸ˆ
- INSERT, UPDATE, DELETE
- SELECT ... FOR UPDATE
- ë°°íƒ€ì  ì ê¸ˆì´ ë°œìƒí•˜ë©´ í•˜ë‚˜ì˜ ë¦¬ì†ŒìŠ¤ë§Œ í•´ë‹¹ ë¶€ë¶„ì„ ì ìœ í•  ìˆ˜ ìˆìŒ



### [References]
- [https://centbin-dev.tistory.com/40](https://centbin-dev.tistory.com/40)
- [https://suhwan.dev/2019/06/09/transaction-isolation-level-and-lock/](https://suhwan.dev/2019/06/09/transaction-isolation-level-and-lock/)
- [https://www.notion.so/05a1d0a9e9c44d12a69d4bf9f1cd2086?v=e617ae925eda4c68805b79bae32bff01&p=0a4bfd8b40184a8182677fe662d7b2ef](https://www.notion.so/05a1d0a9e9c44d12a69d4bf9f1cd2086?v=e617ae925eda4c68805b79bae32bff01&p=0a4bfd8b40184a8182677fe662d7b2ef)
- [https://www.letmecompile.com/mysql-innodb-transaction-model/](https://www.letmecompile.com/mysql-innodb-transaction-model/)